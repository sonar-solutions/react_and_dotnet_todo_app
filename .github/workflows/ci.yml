name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Clean previous backend coverage report
        run: rm -f backend/coverage.opencover.xml

      - name: Run backend tests with OpenCover coverage
        run: |
          cd backend
          dotnet test ../backendTests/backend.Tests.csproj \
            --collect:"XPlat Code Coverage" \
            --results-directory ../TestResults \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover
          OPEN_COVER_PATH=$(find ../TestResults -name 'coverage.opencover.xml' | head -n 1)
          cp "$OPEN_COVER_PATH" coverage.opencover.xml
          cd ..

      - name: Cache backend coverage and build artifacts
        uses: actions/cache@v4
        with:
          path: |
            backend/coverage.opencover.xml
            backend/bin
            backend/obj
            backendTests/bin
            backendTests/obj
            TestResults
          key: backend-${{ github.sha }}

  frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Clean previous frontend coverage report
        run: rm -f frontend/coverage/lcov.info

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Run frontend tests with coverage
        working-directory: frontend
        run: |
          npm test -- --coverage --watchAll=false || true
          if [ -f coverage/lcov.info ]; then
            sed 's|SF:src/|SF:frontend/src/|g' coverage/lcov.info > fixed_lcov.info
            mv fixed_lcov.info coverage/lcov.info
          fi

      - name: Cache frontend coverage and node_modules
        uses: actions/cache@v4
        with:
          path: |
            frontend/coverage/lcov.info
            frontend/node_modules
          key: frontend-${{ github.sha }}

  sonarcloud:
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    env:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_PROJECT_KEY: solutions_react_and_dotnet_todo_app
      SONAR_ORG: sonar-solutions
      SONAR_HOST_URL: https://sonarcloud.io
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '21.6.2'

      - name: Restore backend cache
        uses: actions/cache@v4
        with:
          path: |
            backend/coverage.opencover.xml
            backend/bin
            backend/obj
            backendTests/bin
            backendTests/obj
            TestResults
          key: backend-${{ github.sha }}

      - name: Restore frontend cache
        uses: actions/cache@v4
        with:
          path: |
            frontend/coverage/lcov.info
            frontend/node_modules
          key: frontend-${{ github.sha }}

      - name: Install SonarScanner for .NET
        run: dotnet tool install --global dotnet-sonarscanner

      - name: Install ReportGenerator
        run: dotnet tool install --global dotnet-reportgenerator-globaltool

      - name: SonarScanner begin
        run: |
          OPEN_COVER_ABS_PATH="$(pwd)/backend/coverage.opencover.xml"
          dotnet sonarscanner begin \
            /k:"$SONAR_PROJECT_KEY" \
            /n:"ReactDotnetTodoApp" \
            /v:"1.0" \
            /o:"$SONAR_ORG" \
            /d:sonar.host.url="$SONAR_HOST_URL" \
            /d:sonar.token="$SONAR_TOKEN" \
            /d:sonar.exclusions="**/node_modules/**,**/bin/**,**/obj/**,**/backendTests/**,scan.sh" \
            /d:sonar.test.exclusions="**/backendTests/**" \
            /d:sonar.sourceEncoding="UTF-8" \
            /d:sonar.dotnet.excludeTestProjects=true \
            /d:sonar.cs.opencover.reportsPaths="$OPEN_COVER_ABS_PATH" \
            /d:sonar.javascript.lcov.reportPaths="frontend/coverage/lcov.info" \
            /d:sonar.coverage.exclusions="**/*.test.js,**/setupTests.js" \
            /d:sonar.scm.provider=git \
            /d:sonar.branch.name=test-branch \
            /d:sonar.verbose=true

      - name: Build solution
        run: dotnet build react_and_dotnet.sln

      - name: SonarScanner end
        run: dotnet sonarscanner end "/d:sonar.token=$SONAR_TOKEN"
